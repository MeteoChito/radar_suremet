<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Radar AEMET (Murcia) - Calibración bounds (4 puntos)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .panel{
      position:absolute; top:12px; left:12px; z-index:1000;
      background:rgba(15,22,32,.9); color:#e6edf3;
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px; padding:10px 12px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      font-size:13px; display:grid; gap:8px; min-width:300px; max-width:460px;
    }
    .row{ display:flex; gap:8px; align-items:center; justify-content:space-between; }
    button{
      background:#17202b; color:#e6edf3; border:1px solid #263445;
      border-radius:10px; padding:8px 10px; cursor:pointer; white-space:nowrap;
    }
    button:hover{ background:#1b2633; }
    .muted{ color:#9fb0c0; }
    code{ color:#cfe7ff; }
    .tiny{ font-size:12px; color:#9fb0c0; line-height:1.35; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <b style="color:lime">CALIBRACIÓN 4 PUNTOS ✅</b>
    <div class="row">
      <span id="status" class="muted">Cargando…</span>
      <button id="refresh">Actualizar</button>
    </div>
    <div class="tiny">
      Arrastra <b>NW/NE/SE/SW</b>. Copia los bounds:
    </div>
    <div class="tiny" id="debug">
      SW: <code>—</code><br/>
      NE: <code>—</code>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const PROXY = "https://aemet-proxy.javiermt-chito.workers.dev";
    const RADAR = "mu";

    // Punto de partida (puedes dejarlos como los que ya te funcionaban)
    let corners = {
      NW: [40.40, -3.95],
      NE: [40.40,  1.60],
      SE: [35.50,  1.60],
      SW: [35.50, -3.95],
    };

    const map = L.map("map").setView([37.9, -1.2], 8);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let overlay = null;
    let rect = null;
    const markers = {};

    function setStatus(msg){ document.getElementById("status").textContent = msg; }

    function getBoundsFromCorners() {
      const lats = Object.values(corners).map(c => c[0]);
      const lons = Object.values(corners).map(c => c[1]);
      const minLat = Math.min(...lats);
      const maxLat = Math.max(...lats);
      const minLon = Math.min(...lons);
      const maxLon = Math.max(...lons);
      return { SW: [minLat, minLon], NE: [maxLat, maxLon] };
    }

    function updateDebug() {
      const { SW, NE } = getBoundsFromCorners();
      document.getElementById("debug").innerHTML =
        `SW: <code>[${SW[0].toFixed(5)}, ${SW[1].toFixed(5)}]</code><br/>` +
        `NE: <code>[${NE[0].toFixed(5)}, ${NE[1].toFixed(5)}]</code>`;
      console.log("✅ BOUNDS PARA COPIAR:", { SW, NE, corners });
    }

    function applyBounds() {
      const { SW, NE } = getBoundsFromCorners();
      const bounds = L.latLngBounds(SW, NE);
      if (overlay) overlay.setBounds(bounds);
      if (rect) rect.setBounds(bounds);
      updateDebug();
    }

    function ensureHandles() {
      // Rectángulo visual de bounds
      const { SW, NE } = getBoundsFromCorners();
      const bounds = L.latLngBounds(SW, NE);
      if (!rect) rect = L.rectangle(bounds, { weight: 1, color: "#00e5ff", fillOpacity: 0.05 }).addTo(map);

      // Crea 4 marcadores
      for (const key of ["NW","NE","SE","SW"]) {
        if (!markers[key]) {
          markers[key] = L.marker(corners[key], { draggable: true })
            .addTo(map)
            .bindTooltip(key, { permanent: true, direction: "right" });

          markers[key].on("drag", (e) => {
            const ll = e.target.getLatLng();
            corners[key] = [ll.lat, ll.lng];
            applyBounds();
          });
        } else {
          markers[key].setLatLng(corners[key]);
        }
      }
      applyBounds();
    }

    async function cargarRadar() {
      setStatus("Cargando radar…");
      try {
        const url = `${PROXY}/radar?radar=${encodeURIComponent(RADAR)}`;
        const r = await fetch(url, { headers: { "accept": "application/json" } });
        const txt = await r.text();

        let j;
        try { j = JSON.parse(txt); }
        catch { setStatus(`HTTP ${r.status} (no JSON)`); console.log("CRUDO:", txt); return; }

        if (j.estado !== 200 || !j.datos) {
          setStatus(`Error AEMET: ${j.estado} ${j.descripcion || ""}`.trim());
          return;
        }

        const imgUrl = j.datos + (j.datos.includes("?") ? "&" : "?") + "t=" + Date.now();
        const { SW, NE } = getBoundsFromCorners();
        const bounds = L.latLngBounds(SW, NE);

        if (!overlay) {
          overlay = L.imageOverlay(imgUrl, bounds, { opacity: 0.9 }).addTo(map);
          ensureHandles();
          setStatus("OK (calibrando 4 puntos)");
        } else {
          overlay.setUrl(imgUrl);
          setStatus("OK (actualizado)");
        }
      } catch (e) {
        console.error("ERROR:", e);
        setStatus("Error JS: " + (e?.message || e));
      }
    }

    document.getElementById("refresh").addEventListener("click", cargarRadar);
    cargarRadar();
  </script>
</body>
</html>

