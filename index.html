<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Radar AEMET (Murcia) - Calibración bounds</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .panel{
      position:absolute; top:12px; left:12px; z-index:1000;
      background:rgba(15,22,32,.9); color:#e6edf3;
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px; padding:10px 12px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      font-size:13px; display:grid; gap:8px; min-width:280px; max-width:420px;
    }
    .row{ display:flex; gap:8px; align-items:center; justify-content:space-between; }
    button{
      background:#17202b; color:#e6edf3; border:1px solid #263445;
      border-radius:10px; padding:8px 10px; cursor:pointer; white-space:nowrap;
    }
    button:hover{ background:#1b2633; }
    .muted{ color:#9fb0c0; }
    code{ color:#cfe7ff; }
    .tiny{ font-size:12px; color:#9fb0c0; line-height:1.35; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <b style="color:lime">CALIBRACIÓN ✅</b>
    <div class="row">
      <span id="status" class="muted">Cargando…</span>
      <button id="refresh">Actualizar</button>
    </div>

    <div class="tiny">
      Arrastra los marcadores <b>SW</b> y <b>NE</b> para mover/estirar el radar.<br/>
      Copia estos bounds:
    </div>

    <div class="tiny" id="debug">
      SW: <code>—</code><br/>
      NE: <code>—</code>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const PROXY = "https://aemet-proxy.javiermt-chito.workers.dev";
    const RADAR = "mu";

    // Bounds iniciales (punto de partida)
    let SW = [35.50, -3.95];
    let NE = [40.40,  1.60];

    const map = L.map("map").setView([37.9, -1.2], 8);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let overlay = null;
    let rect = null;
    let mSW = null;
    let mNE = null;

    function setStatus(msg){ document.getElementById("status").textContent = msg; }

    function updateDebug() {
      document.getElementById("debug").innerHTML =
        `SW: <code>[${SW[0].toFixed(5)}, ${SW[1].toFixed(5)}]</code><br/>` +
        `NE: <code>[${NE[0].toFixed(5)}, ${NE[1].toFixed(5)}]</code>`;
      console.log("BOUNDS:", { SW, NE });
    }

    function applyBounds() {
      const bounds = L.latLngBounds(SW, NE);
      if (overlay) overlay.setBounds(bounds);
      if (rect) rect.setBounds(bounds);
      updateDebug();
    }

    function ensureHandles() {
      const bounds = L.latLngBounds(SW, NE);

      if (!rect) {
        rect = L.rectangle(bounds, { weight: 1, color: "#00e5ff", fillOpacity: 0.05 }).addTo(map);
      }

      if (!mSW) {
        mSW = L.marker(SW, { draggable: true }).addTo(map).bindTooltip("SW", {permanent:true, direction:"right"});
        mSW.on("drag", (e) => {
          const ll = e.target.getLatLng();
          SW = [ll.lat, ll.lng];
          // evita invertir bounds
          if (SW[0] > NE[0]) SW[0] = NE[0] - 0.01;
          if (SW[1] > NE[1]) SW[1] = NE[1] - 0.01;
          applyBounds();
        });
      } else {
        mSW.setLatLng(SW);
      }

      if (!mNE) {
        mNE = L.marker(NE, { draggable: true }).addTo(map).bindTooltip("NE", {permanent:true, direction:"right"});
        mNE.on("drag", (e) => {
          const ll = e.target.getLatLng();
          NE = [ll.lat, ll.lng];
          if (NE[0] < SW[0]) NE[0] = SW[0] + 0.01;
          if (NE[1] < SW[1]) NE[1] = SW[1] + 0.01;
          applyBounds();
        });
      } else {
        mNE.setLatLng(NE);
      }

      applyBounds();
    }

    async function cargarRadar() {
      setStatus("Cargando radar…");
      try {
        const url = `${PROXY}/radar?radar=${encodeURIComponent(RADAR)}`;
        const r = await fetch(url, { headers: { "accept": "application/json" } });
        const txt = await r.text();

        let j;
        try { j = JSON.parse(txt); }
        catch {
          setStatus(`HTTP ${r.status} (no JSON)`);
          console.log("RESPUESTA CRUDA:", txt);
          return;
        }

        if (j.estado !== 200 || !j.datos) {
          setStatus(`Error AEMET: ${j.estado} ${j.descripcion || ""}`.trim());
          return;
        }

        const imgUrl = j.datos + (j.datos.includes("?") ? "&" : "?") + "t=" + Date.now();

        if (!overlay) {
          overlay = L.imageOverlay(imgUrl, L.latLngBounds(SW, NE), { opacity: 0.9 }).addTo(map);
          ensureHandles();
          setStatus("OK (calibrando)");
        } else {
          overlay.setUrl(imgUrl);
          setStatus("OK (actualizado)");
        }
      } catch (e) {
        console.error("ERROR:", e);
        setStatus("Error JS: " + (e?.message || e));
      }
    }

    document.getElementById("refresh").addEventListener("click", cargarRadar);
    cargarRadar();
  </script>
</body>
</html>

